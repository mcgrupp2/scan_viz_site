---
title: "Model Testing Results"
output:
  html_document:
    css: "site_themes.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=F,message=F)
```


<script>
$(document).ready(function() {
  $head = $('#navbar');
  $head.append('<a href=\"https://www.lutzlab.org/\"><img src=\"https://i.pinimg.com/originals/f6/4c/8d/f64c8dbcffd405294d2943810974e2c1.jpg\" style=\"float: right;width: 75px;\"/></a>')
});
</script>



```{css, echo=FALSE}

.chart-wrapper {
  position: absolute;
  left: 50px;
}

.vega-bind:first-child {
  position: fixed;
  left: 20px;
  top: 200px;
}

.vega-bind:nth-child(2) {
  position: fixed;
  left: 20px;
  top: 300px;
}

.vega-bind:last-child {
  position: fixed;
  left: 20px;
  top: 400px;
}

```


```{r message=FALSE, warning=FALSE, include=FALSE}
library(reticulate)
library(vegawidget)
library(bsplus)
library(htmltools)
```

```{r echo=FALSE}
bs_modal(
  id = "modal_markdown", 
  title = "Visualization Explanation",
  body = includeMarkdown("stuff.md"),
  size = "large"
)
bs_button("Visualization Info", button_type = "success",button_size ="extra-small",id="info_modal") %>%
  bs_attach_modal("modal_markdown")
```


```{python include=FALSE}
import numpy as np
import pandas as pd
import altair as alt
from sklearn.metrics import balanced_accuracy_score, log_loss, f1_score, precision_score, accuracy_score,recall_score,roc_curve,precision_recall_curve,matthews_corrcoef,cohen_kappa_score,auc
alt.data_transformers.disable_max_rows()

```

```{python include=FALSE}
source = pd.read_csv('/Users/jason/Library/CloudStorage/OneDrive-UW/Documents/research_projects/202109_dedx/220202_preds.csv')

source=source.iloc[:,1:]

y_scoring2=source['target']
rf_y_pred2=source['rf']
xg_y_pred2=source['xg']
logit_y_pred2=source['logit']
et_y_pred2=source['et']
gbc_y_pred2=source['gbc']
eclf_y_pred2=source['eclf']

rf_fpr, rf_tpr, rf_thresholdz = roc_curve(y_scoring2,rf_y_pred2)
xg_fpr, xg_tpr, xg_thresholdz = roc_curve(y_scoring2,xg_y_pred2)
logit_fpr, logit_tpr, logit_thresholdz = roc_curve(y_scoring2,logit_y_pred2)
et_fpr, et_tpr, et_thresholdz = roc_curve(y_scoring2,et_y_pred2)
gbc_fpr, gbc_tpr, gbc_thresholdz = roc_curve(y_scoring2,gbc_y_pred2)
eclf_fpr, eclf_tpr, eclf_thresholdz = roc_curve(y_scoring2,eclf_y_pred2)



rf_precision, rf_recall, rf_thresholds = precision_recall_curve(y_scoring2, rf_y_pred2) 
xg_precision, xg_recall, xg_thresholds = precision_recall_curve(y_scoring2, xg_y_pred2) 
logit_precision, logit_recall, logit_thresholds = precision_recall_curve(y_scoring2, logit_y_pred2)

et_precision, et_recall, et_thresholds = precision_recall_curve(y_scoring2, et_y_pred2)
gbc_precision,gbc_recall, gbc_thresholds = precision_recall_curve(y_scoring2, gbc_y_pred2)

eclf_precision, eclf_recall, eclf_thresholds = precision_recall_curve(y_scoring2, eclf_y_pred2) 

def compute_f1(prec,recall):
    return (2 * prec * recall) / (prec + recall)

rf_best_thresh=rf_thresholds[np.nanargmax([compute_f1(p,r) for p,r in zip(rf_precision,rf_recall)])]
xg_best_thresh=xg_thresholds[np.nanargmax([compute_f1(p,r) for p,r in zip(xg_precision,xg_recall)])]
logit_best_thresh=logit_thresholds[np.nanargmax([compute_f1(p,r) for p,r in zip(logit_precision,logit_recall)])]
et_best_thresh=et_thresholds[np.nanargmax([compute_f1(p,r) for p,r in zip(et_precision,et_recall)])]
gbc_best_thresh=gbc_thresholds[np.nanargmax([compute_f1(p,r) for p,r in zip(gbc_precision,gbc_recall)])]
eclf_best_thresh=eclf_thresholds[np.nanargmax([compute_f1(p,r) for p,r in zip(eclf_precision,eclf_recall)])]

rf_gmeans = np.sqrt(rf_tpr * (1-rf_fpr))
xg_gmeans = np.sqrt(xg_tpr * (1-xg_fpr))
logit_gmeans = np.sqrt(logit_tpr * (1-logit_fpr))
et_gmeans = np.sqrt(et_tpr * (1-et_fpr))
gbc_gmeans = np.sqrt(gbc_tpr * (1-gbc_fpr))
eclf_gmeans = np.sqrt(eclf_tpr * (1-eclf_fpr))
#sclf_gmeans = np.sqrt(sclf_tpr * (1-sclf_fpr))
# locate the index of the largest g-mean
rf_ix = np.argmax(rf_gmeans)
xg_ix = np.argmax(xg_gmeans)
logit_ix = np.argmax(logit_gmeans)
et_ix = np.argmax(et_gmeans)
gbc_ix = np.argmax(gbc_gmeans)
eclf_ix = np.argmax(eclf_gmeans)

# # apply threshold to positive probabilities to create labels
def to_labels(pos_probs, threshold):
 	return (pos_probs >= threshold).astype('int')

```



```{python include=FALSE,warning=F,message=F}


alt.data_transformers.disable_max_rows()

source_df=source.reset_index().melt(id_vars=['index','target'],var_name='classifier',value_name='pred')


# sns.scatterplot(data=df, x="index", y="pred_prob",hue='response')
# plt.show()
y_slider_df=pd.DataFrame({'thresh': np.arange(0,1,0.0001)})

slider = alt.binding_range(name="High Threshold", min=0, max=1, step=0.001)
select_thresh = alt.selection_single(fields=['thresh'],
                                   bind=slider, init={'thresh': round(eclf_best_thresh,3)})

slider2 = alt.binding_range(min=0, max=1, step=0.001,name="Low Threshold")
select_thresh2 = alt.selection_single(fields=['thresh'],
                                   bind=slider2, init={'thresh': round(eclf_thresholds[eclf_ix],3)})

yrule = alt.Chart(y_slider_df).mark_rule().encode(y='thresh:Q').add_selection(
    select_thresh
).transform_filter(
    select_thresh
)

yrule2 = alt.Chart(y_slider_df).mark_rule().encode(y='thresh:Q').add_selection(
    select_thresh2
).transform_filter(
    select_thresh2
)


genre_dropdown = alt.binding_select(options=np.unique(source_df['classifier']),name="Choose Model: ")
genre_select = alt.selection_single(fields=['classifier'], bind=genre_dropdown,init={'classifier': 'et'})


color = alt.condition(alt.datum.pred<=select_thresh.thresh,
                      alt.value('orangered'),
                      alt.Color('target:Q', scale=alt.Scale(scheme='greens')),legend=None)

# color = alt.condition({
#   'condition': {'test': '(datum.pred <= High.thresh)', 'value': 'darkred'},
#   'scale': alt.Scale({
#     'scheme': 'reds'
#   }),
#   'shorthand': 'target:Q'
# })

opacity = alt.condition(alt.datum.target==0, alt.value(0.2), alt.value(0.8),legend=None)

base=alt.Chart(source_df).mark_circle(size=60,color='lightgrey').encode(
    x=alt.X('index',axis=None),
    y=alt.Y('pred',scale=alt.Scale(domain=(0, 1)),axis=alt.Axis(title="Predicted Probability")),
    tooltip=['index','pred', 'target']
).add_selection(
    genre_select
).transform_filter(
    genre_select
).transform_filter(
    alt.datum.pred <= select_thresh2.thresh
).properties(title="Model Diagnosed",width=500).interactive()


base2=alt.Chart(source_df).mark_circle(size=60).encode(
    x=alt.X('index',axis=None),
    y=alt.Y('pred',scale=alt.Scale(domain=(0, 1)),axis=alt.Axis(title="Predicted Probability")),
    color=color,
    opacity=opacity,
    tooltip=['index','pred', 'target']
).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh)
).properties(title="Higher Performance Tests",width=500).interactive()


base3=alt.Chart(source_df).mark_circle(size=60).encode(
    x=alt.X('index',axis=None),
    y=alt.Y('pred',scale=alt.Scale(domain=(0, 1)),axis=alt.Axis(title="Predicted Probability")),
    color=alt.Color('target:Q',legend=None),
    tooltip=['index','pred', 'target']
).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh.thresh)
).properties(title="Rapid Diagnostic Tests",width=500).interactive()




text = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    alt.datum.pred <= select_thresh2.thresh
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source.shape[0]
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


text2 = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred <= select_thresh2.thresh)
).transform_aggregate(
    total_count2='count(target)',
    total_pos='sum(target)'
).transform_calculate(
    pct=alt.datum.total_pos/source[source['target']==1].shape[0]
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


bar=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    alt.datum.pred <= select_thresh2.thresh
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source.shape[0]
).mark_bar(color='lightgray').encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percent of Total Population Served"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p'),alt.Tooltip('total_count2:Q')]
).interactive()


bar2=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred <= select_thresh2.thresh)# & (alt.datum.target == 1)
).transform_aggregate(
    total_count='count(target)',
    total_pos='sum(target)'
).transform_calculate(
    #pct=alt.datum.total_count/source[source['target']==1].shape[0]
    pct=alt.datum.total_pos/source[source['target']==1].shape[0]
).mark_bar(color='lightgray').encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percentage of Total Positives"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p'),alt.Tooltip('total_pos:Q')]
).properties(width=50).interactive()


textb = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred <= select_thresh2.thresh) 
).transform_joinaggregate(
    total_count2='count(target)',
#).transform_aggregate(
    total_pos='sum(target)',
).transform_calculate(
    pct=(alt.datum.total_count2-alt.datum.total_pos)/(alt.datum.total_count2+alt.datum.total_pos)
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


barb=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred <= select_thresh2.thresh) 
).transform_joinaggregate(
    total_count2='count(target)',
#).transform_aggregate(
    total_pos='sum(target)',
).transform_calculate(
    pct=(alt.datum.total_count2-alt.datum.total_pos)/(alt.datum.total_count2+alt.datum.total_pos)
).mark_bar(color='lightgray').encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Negative Predictive Value"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p',title="NPV"),alt.Tooltip('total_count2:Q',title="True Negatives"),alt.Tooltip('total_pos:Q',title="False Negatives")]
).interactive()



text3 = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh)
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source.shape[0]
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


text4 = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh) & (alt.datum.target == 1)
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source[source['target']==1].shape[0]
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


bar3=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh)
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source.shape[0]
).mark_bar(color='orangered').encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percent of Total Population Served"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p'),alt.Tooltip('total_count2:Q')]
).properties(width=50).interactive()


bar4=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh) & (alt.datum.target == 1)
).transform_aggregate(
    total_count='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count/source[source['target']==1].shape[0]
).mark_bar(color='orangered').encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percentage of Total Positives"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p'),alt.Tooltip('total_count:Q')]
).properties(width=50).interactive()


barc=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh)
).transform_aggregate(
    total_count2='count(target)',
    total_pos='sum(target)'
).transform_calculate(
    total_neg=alt.datum.total_count2-alt.datum.total_pos,
    pct=alt.datum.total_pos/alt.datum.total_count2
).mark_bar(color='orangered').encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percentage of Positives in Sample"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p'),alt.Tooltip('total_count2:Q'),alt.Tooltip('total_pos:Q')]
).properties(width=50).interactive()



textc = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred <= select_thresh.thresh)
).transform_aggregate(
    total_count2='count(target)',
    total_pos='sum(target)'
).transform_calculate(
    total_neg=alt.datum.total_count2-alt.datum.total_pos,
    pct=alt.datum.total_pos/alt.datum.total_count2
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)



# (base+yrule2|((bar+text)|(bar2+text2)|barb+textb))&(base2+yrule+yrule2|((bar3+text3)|(bar4+text4)))





text5 = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh.thresh) 
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source.shape[0]
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


text6 = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh.thresh) & (alt.datum.target == 1)
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source[source['target']==1].shape[0]
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)


bar5=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh.thresh)
).transform_aggregate(
    total_count2='count(alt.datum.target)',
    total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count2/source.shape[0]
).mark_bar(color="seagreen").encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percent of Population Served"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p')]
).interactive()


bar6=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh.thresh) & (alt.datum.target == 1)
).transform_aggregate(
    total_count='count(target)',
    # total_pos='average(alt.datum.target)'
).transform_calculate(
    pct=alt.datum.total_count/source[source['target']==1].shape[0]
).mark_bar(color="seagreen").encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percentage of Total Positives"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p')]
).properties(width=50).interactive()

bard=alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred > select_thresh.thresh)
).transform_aggregate(
    total_count2='count(target)',
    total_pos='sum(target)'
).transform_calculate(
    pct=alt.datum.total_pos/alt.datum.total_count2
).mark_bar(color="seagreen").encode(
    y=alt.Y('pct:Q',scale=alt.Scale(domain=(0, 1)),title="Percentage of Positives in Sample"),
    tooltip=[alt.Tooltip('pct:Q',format='.3p'),alt.Tooltip('total_count2:Q'),alt.Tooltip('total_pos:Q')]
).interactive()



textd = alt.Chart(source_df).transform_filter(
    genre_select
).transform_filter(
    (alt.datum.pred > select_thresh2.thresh) & (alt.datum.pred > select_thresh.thresh)
).transform_aggregate(
    total_count2='count(target)',
    total_pos='sum(target)'
).transform_calculate(
    pct=alt.datum.total_pos/alt.datum.total_count2
).mark_text(dy=-5, color='black').encode(
    y=alt.Y('pct:Q', stack='zero'),
    text=alt.Text('pct:Q', format='.3p')
)






```

```{python include=F,message=FALSE,warning=FALSE}
ind_chart=(base+yrule2|((bar+text)|(bar2+text2)|barb+textb))&(base2+yrule+yrule2|((bar3+text3)|(bar4+text4)|(barc+textc)))&(base3+yrule|((bar5+text5)|(bar6+text6)|(bard+textd)))

ichart=ind_chart.to_json() 
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
as_vegaspec(py$ichart)
```


